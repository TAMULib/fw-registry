{
  "id": "b3edd0b1-9611-4973-ad53-9f0e9f0f9e1e",
  "name": "Query Daily Fees/Fines Paid from MetaDb",
  "description": "",
  "deserializeAs": "DatabaseQueryTask",
  "inputVariables": [
    {
      "key": "timestamp",
      "type": "PROCESS"
    },
    {
      "key": "tenantId",
      "type": "PROCESS"
    }
  ],
  "outputVariable": {
    "key": "count",
    "type": "PROCESS"
  },
  "outputPath": "/mnt/workflows/${tenantId}/circ-fines/feefines-report-${timestamp}.tsv",
  "resultType": "TSV",
  "designation": "metadb",
  "query": "SELECT DISTINCT isp.NAME AS service_point, actions.payment_method AS method, users.\"jsonb\" -> 'barcode' as userBarcode, Concat(users.\"jsonb\" -> 'personal' ->> 'lastName', ' ',users.\"jsonb\" -> 'personal' ->> 'firstName') AS NAME,to_char(actions.date_action at time zone 'America/Chicago','YYYYMMDD HH24:MI:SS') AS action_date, actions.source AS operator, actions.amount_action AS amount, actions.comments AS comments,actions.id FROM folio_audit.circulation_logs logs, folio_inventory.service_point__t isp,folio_users.users users, folio_feesfines.accounts accounts, folio_feesfines.feefineactions__t actions WHERE  actions.type_action IN ( 'Paid fully', 'Paid partially' )  AND isp.id = (logs.\"jsonb\" ->> 'servicePointId')::uuid AND (logs.\"jsonb\" -> 'linkToIds' ->> 'feeFineId')::uuid = accounts.id AND actions.user_id = users.id AND actions.account_id = accounts.id AND CAST(logs.\"jsonb\" ->> 'date' AS DATE) = CURRENT_DATE - 1 AND isp.NAME IN ( 'Ask Us Desk (Evans)', 'Business Library Circulation','InterLibrary Loan Dept. (Evans)', 'Maps & GIS', 'Media and Reserves', 'PSEL Circulation Desk' ) ORDER  BY action_date DESC",
  "asyncBefore": true
}
